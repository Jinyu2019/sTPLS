---
title: "Application on GDSC dataset"
output: html_document
---

This file outlines the key steps of sTPLS when applying to the paired gene expresssion and drug response data from the GDSC dataset.

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "D:/Github/sTPLS")
```

### Load the libraries

```{r libraries, echo = F}
library(reshape2)
library(MASS)
library(ggplot2)
suppressPackageStartupMessages(library(ComplexHeatmap))
library(irlba)
library(cowplot)
library(ggpubr)
library(gridExtra)
suppressPackageStartupMessages(library(circlize)) 
library(RColorBrewer)
library(scico)
```

### Load input data

The input tensor was generated by "./R/generate_GDSC_data.R"

```{r tensor data}
data.type = "GDSC_data" # all related results are saved in "./examples/data.type/"
data.tensor = readRDS("./data/GDSC_data_tensor.RDS")  
```

### Select parameters

Given candidates for parameters (alpha_cu, alpha_cv, beta), sTPLS algorithm using each group of parameters is executed to identify comodules. The median of modularity scores for all comodules is used to evaluate the performance when using different parameters. The optimal parameters corresponding to the largest score are selected. Considering the influence of comodules size on scores, we computed the median of modularity scores for comodules when selecting different numbers of three types of members in comodules by setting uthrd, vthrd and wthrd.

Firstly set candidates for parameters (alpha_cu, alpha_cv, beta).

```{r}
nfactor = 10 # the number of identified comodules
beta_list = seq(from = 1.5, to = 2.5, by = 0.5) # beta for weight w
alpha_cu_list = c(0.1, 0.2, 0.3)  # alpha for c_u
alpha_cv_list = c(0.1, 0.2, 0.3)  # alpha for c_v

combparams = expand.grid(beta_list, alpha_cu_list, alpha_cv_list, nfactor)
colnames(combparams) = c("beta","alpha_cu","alpha_cv","nfactor")
```

Then set candidates for the number of selected members in comodules. They could be set according to the user's expectations for comodules size and understanding of the input data.

```{r}
uthrd_list = c(5,10,15) # the number of selected drugs
vthrd_list = c(100,150,200) # the number of selected genes
wthrd_list = 1:3 # the number of selected cancer types
uvwthrds = expand.grid(uthrd_list, vthrd_list, wthrd_list)
colnames(uvwthrds) = c("uthrd", "vthrd", "wthrd")
```

Lastly select the optimal parameters (alpha_cu, alpha_cv, beta) in sTPLS.

```{r}
source("./R/select_params.R")
opt_params = select_params(data_tensor=data.tensor, parameter_list=combparams, uvwthrd_list=uvwthrds, data_type=data.type)
```

Set the parameters in sTPLS.

```{r}
beta = opt_params$beta # beta for weight w
alpha_cu = opt_params$alpha_cu # alpha for c_u
alpha_cv = opt_params$alpha_cv # alpha for c_v
nfactor = opt_params$nfactor # the number of identified comodules
```

### Run sTPLS algorithm
Run sTPLS using the selected parameters and save the results in the directory "./examples/GDSC_data". 

```{r}
source("./R/utils_for_sTPLS.R")
out.sTPLS = run_sTPLS(data_tensor=data.tensor, alpha_cu=alpha_cu, alpha_cv=alpha_cv, beta=beta, nfactor=nfactor, data_type=data.type)

```

### Visualize sTPLS results
Draw heatmaps of weight matrices U,V,W.

```{r}
# weight matrices of sTPLS
U=out.sTPLS$U; V=out.sTPLS$V; W=out.sTPLS$W
plot_UVW(U,V,W)

```

### Determine comodule members

Comodule members are determined based on weight matrices U,V and W. Thresholds (uthrd, vthrd, wthrd) should be set for selecting comodule members (i.e., features corresponding to three dimensions of input tensor). Adjust them for selecting comodules in proper size users prefer to. The larger the thresholds are, the less members are selected.

```{r}
uthrd = 3.5; vthrd = 3.5; wthrd = 1 # thresholds for selection comodule members
weight_list = list(U=U,V=V,W=W)
uvwthrd_list = list(uthrd=uthrd, vthrd=vthrd, wthrd=wthrd)
comodules = determine_comodule(weight_list, uvwthrd_list)

```

List the comodule members.

```{r}
print(head(comodules[[8]]$Dim1))
print(head(comodules[[8]]$Dim2))
print(head(comodules[[8]]$Dim3))

```

Save comodules and write the comodules in an excel file.

```{r}
resfolder = paste0("./examples/", data.type, "/")
save(comodules, file = paste0(resfolder, "comodules.RData"))

comodule_to_excel(comodules, destdir=resfolder)
```

### Visualize comodules

Demonstrate the comodules' composition. Each row represents one comodule, and each column represents one feature. If feature j is included in the comodule Mi, the corresponding position (i, j) is filled in black color.

```{r}
source("./R/comodule_heatmap.R")
plot_comodule_member(tensor=data.tensor, comodules=comodules)
```

Draw heatmaps of comodules, unfold tensor along the condition dimension.

```{r}

# Draw heatmaps of comodule 1 and 8.
plot_comodule_heatmap(tensor=data.tensor, weight_list=weight_list, comodules=comodules, mindex=c(1,8))
```
