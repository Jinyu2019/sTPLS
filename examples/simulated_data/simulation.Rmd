---
title: "Application on simulated data"
output: html_document
---

This file outlines the key steps of sTPLS when applying to simulated data which are generated by the R script "./R/generate_simulated_data.R".

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "D:/Github/sTPLS")
```

### Load the libraries

```{r libraries, echo = F}
library(reshape2)
library(MASS)
library(ggplot2)
suppressPackageStartupMessages(library(ComplexHeatmap))
library(irlba)
library(cowplot)
library(ggpubr)
library(gridExtra)
suppressPackageStartupMessages(library(circlize)) 
library(RColorBrewer)
library(scico)
```

### Generate input tensor data

```{r tensor data}
data.type = "simulated_data"
res = readRDS("./data/simulated_data_XY.RDS")
Xlist = res$Xlist
Ylist = res$Ylist
Xfeatures = res$Xfeatures
Yfeatures = res$Yfeatures
Conditions = res$Conditions
# true_comodules = res$true_comodules

p = dim(Xlist[[1]])[2]
q = dim(Ylist[[1]])[2]
nTypes = length(Xlist)

data.tensor = array(0, c(p,q,nTypes))
for(i in 1:nTypes){
  data.tensor[,,i] = cor(Xlist[[i]], Ylist[[i]])
}
dimnames(data.tensor)[[1]] = Xfeatures
dimnames(data.tensor)[[2]] = Yfeatures
dimnames(data.tensor)[[3]] = Conditions
```

### Visualize tensor
Visualize each slice of tensor.
```{r visualization}
ht1 = Heatmap(data.tensor[,,1], name = "1", cluster_rows = F, cluster_columns = F,show_row_names=F, show_column_names=F,column_title = "A(:,:,1)", height = unit(6,"cm"), show_heatmap_legend = FALSE)
ht2 = Heatmap(data.tensor[,,2], name = "2", cluster_rows = F, cluster_columns = F,show_row_names=F, show_column_names=F,column_title = "A(:,:,2)", height = unit(6,"cm"), show_heatmap_legend = FALSE)
ht3 = Heatmap(data.tensor[,,3], name = "3", cluster_rows = F, cluster_columns = F,show_row_names=F, show_column_names=F,column_title = "A(:,:,3)", height = unit(6,"cm"), show_heatmap_legend = FALSE)
ht4 = Heatmap(data.tensor[,,4], name = " ", cluster_rows = F, cluster_columns = F,show_row_names=F, show_column_names=F,column_title = "A(:,:,4)", height = unit(6,"cm"), show_heatmap_legend = T)

# png(filename="./examples/simulated_data/Heatmap_tensor.png", width=240*4, height=240)
draw(ht1 + ht2 + ht3 + ht4, merge_legend = TRUE)
# dev.off()

saveRDS(data.tensor, file = "./data/simulated_data_tensor.RDS")
```

### Select parameters

Given candidates for parameters (alpha_cu, alpha_cv, beta), sTPLS algorithm using each group of parameters is executed to identify comodules. The median of modularity scores for all comodules is used to evaluate the performance when using different parameters. The optimal parameters corresponding to the largest score are selected. Considering the influence of comodules size on scores, we computed the median of modularity scores for comodules when selecting different numbers of three types of members in comodules by setting uthrd, vthrd and wthrd.

Firstly set candidates for parameters (alpha_cu, alpha_cv, beta).

```{r}
nfactor = 4 # the number of identified comodules
beta_list = c(2,2.5,3) # beta for weight w
alpha_cu_list =  c(0.2, 0.3, 0.4)  # alpha for c_u
alpha_cv_list =  c(0.2, 0.3, 0.4)  # alpha for c_v

combparams = expand.grid(beta_list, alpha_cu_list, alpha_cv_list, nfactor)
colnames(combparams) = c("beta","alpha_cu","alpha_cv", "nfactor")
```

Then set candidates for the number of selected members in comodules. They could be set according to the userâ€™s expectations for comodules size and understanding of the input data.

```{r}
uthrdlist = c(40,50) # the number of selected features in X
vthrdlist = c(40,50) # the number of selected features in Y
wthrdlist = 1:3 # the number of selected conditions
uvwthrds = expand.grid(uthrdlist, vthrdlist, wthrdlist)
colnames(uvwthrds) = c("uthrd", "vthrd", "wthrd")
```

Lastly select the optimal parameters (alpha_cu, alpha_cv, beta) in sTPLS.

```{r}
source("./R/select_params.R")
opt_params = select_params(data_tensor=data.tensor, parameter_list=combparams, uvwthrd_list=uvwthrds, data_type=data.type)
```

Set the parameters in sTPLS.

```{r}
beta = opt_params$beta # beta for weight w
alpha_cu = opt_params$alpha_cu # alpha for c_u
alpha_cv = opt_params$alpha_cv # alpha for c_v
nfactor = opt_params$nfactor # the number of identified comodules
```

### Run sTPLS algorithm

Run sTPLS using the selected parameters and save the results in the directory './examples/simulated_data/'.

```{r}
source("./R/utils_for_sTPLS.R")
out.sTPLS = run_sTPLS(data_tensor=data.tensor, alpha_cu=alpha_cu, alpha_cv=alpha_cv, beta=beta, nfactor=nfactor, data_type=data.type)
```

### Visualize sTPLS results

Draw heatmaps of weight matrices U,V,W.

```{r}
# weight matrices of sTPLS
U=out.sTPLS$U; V=out.sTPLS$V; W=out.sTPLS$W
uheatmap = Heatmap(U, name = " ",
                   cluster_rows = F, cluster_columns = F,
                   show_row_names=F, show_column_names=T,
                   column_title ="U", column_labels = paste0("M",1:ncol(U)),
                   width = unit(3, "cm"), height = unit(5,"cm"))
vheatmap = Heatmap(V, name = " ",
                   cluster_rows = F, cluster_columns = F,
                   show_row_names=F, show_column_names=T,
                   column_title ="V", column_labels = paste0("M",1:ncol(V)),
                   width = unit(3, "cm"), height = unit(5,"cm"))
wheatmap = Heatmap(W, name = " ", 
                   cluster_rows = F, cluster_columns = F, 
                   show_row_names=T, show_column_names=T, 
                   column_title ="W", column_labels = paste0("M",1:ncol(W)),
                   width = unit(3, "cm"), height=unit(5,"cm"),
                   row_names_side ="left", 
                   col = circlize::colorRamp2(c(0, 1), c("grey", "red")))

draw(uheatmap)
draw(vheatmap)
draw(wheatmap)


# plot_UVW(U,V,W)
```

### Determine comodule members

Comodule members are determined based on weight matrices U,V and W. Thresholds (uthrd, vthrd, wthrd) should be set for selecting comodule members (i.e., features corresponding to three dimensions of input tensor). Set them for selecting comodules with proper size you prefer to. The larger the thresholds are, the less members are selected.

```{r}
uthrd = 0.5; vthrd = 0.5; wthrd = 0 # thresholds for selection comodule members
weight_list = list(U=U,V=V,W=W)
uvwthrd_list = list(uthrd=uthrd, vthrd=vthrd, wthrd=wthrd)
comodules = determine_comodule(weight_list, uvwthrd_list)
```

List the comodule members.

```{r}
print(head(comodules[[1]]$Dim1))
print(head(comodules[[1]]$Dim2))
print(head(comodules[[1]]$Dim3))

# save comodules
resfolder = paste0("./examples/", data.type, "/")
save(comodules, file = paste0(resfolder, "comodules.RData"))

# output the comodules in an excel file.
comodule_to_excel(comodules, destdir=resfolder)
```

### Visualize comodules

Draw heatmaps of the composition of comodules. Each row represents one comodule, and each column represents one feature. If feature j is included in the comodule Mi, the corresponding position (i, j) is filled in black color.

```{r}
source("./R/comodule_heatmap.R")
plot_comodule_member(tensor=data.tensor, comodules=comodules)
```

Draw heatmaps of comodules, unfold tensor along the condition dimension.

```{r}
# Draw heatmaps of comodules 1-4.
plot_comodule_heatmap(tensor=data.tensor, weight_list=weight_list, comodules = comodules, mindex=1:4)
```


